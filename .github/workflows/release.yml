name: Release

on:
  push:
    tags: [ 'v*.*.*' ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version for info only'
        required: false
      dry_run:
        description: 'Dry run only (no publish)'
        required: true
        default: true
        type: boolean

permissions:
  contents: read

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  PACKAGE_DIR: dist

jobs:
  publish:
    name: Publish to npm with provenance
    runs-on: ubuntu-latest
    environment: npm-publish
    permissions:
      contents: write            # for GitHub Release creation
      id-token: write            # required for `npm publish --provenance`
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && inputs.dry_run == 'false')

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3
        with:
          submodules: recursive
          fetch-depth: 0
          persist-credentials: false

      # ---------- Canonical environment: Node 24 + pnpm ----------

      - name: Install pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
        with:
          version: 10.23.0

      - name: Setup Node 25
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903
        with:
          node-version: "25.1.0"
          registry-url: https://registry.npmjs.org
          package-manager-cache: false

      - name: Setup Bun
        uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76
        with:
          bun-version: "1.3.3"
          no-cache: true

      - name: Enable Corepack / pin pnpm
        run: |
          corepack enable
          corepack prepare pnpm@10.23.0 --activate
          pnpm -v

      - name: Install deps (deterministic)
        run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Cleanup
        run: pnpm run clean

      - name: Build Test
        run: pnpm run build

      - name: Test demo
        run: pnpm run test:demo
      
      - name: Test Lib
        run: pnpm run test:jit

      - name: Test (Release build)
        run: pnpm run test

      - name: Clean build
        run: pnpm run clean

      - name: Build Release
        run: pnpm run build

      - name: Pack & publish with provenance
        working-directory: ${{ env.PACKAGE_DIR }}
        env:
          NPM_CONFIG_PROVENANCE: "true"
          DRY_RUN: ${{ inputs.dry_run }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
        run: |
          set -euo pipefail
          OUT=$(npm pack --json)
          TARBALL=$(node -e "console.log(JSON.parse(process.argv[1])[0].filename)" "$OUT")
          echo "Tarball: $TARBALL"
          # publish the exact tarball only if not dry run
          if [ "${DRY_RUN}" != "true" ] && [ "${GITHUB_EVENT_NAME}" == "push" ]; then
            npm publish "$TARBALL" --provenance --access public
          else
            echo "Skipping publish (dry_run=${DRY_RUN})"
          fi
